<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebPushKit Test</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    h1 { color: #00d4ff; }
    .section {
      background: #16213e;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .section h2 {
      margin-top: 0;
      color: #00d4ff;
      font-size: 1.1rem;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #aaa;
      font-size: 0.9rem;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #333;
      border-radius: 4px;
      background: #0f0f23;
      color: #eee;
      font-family: monospace;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: #00d4ff;
    }
    button {
      padding: 12px 24px;
      margin-right: 10px;
      margin-bottom: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: transform 0.1s, opacity 0.2s;
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: #00d4ff; color: #000; }
    .btn-success { background: #00ff88; color: #000; }
    .btn-danger { background: #ff4757; color: #fff; }
    .btn-secondary { background: #666; color: #fff; }
    #log {
      background: #0f0f23;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 15px;
      height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.85rem;
      line-height: 1.5;
    }
    .log-entry { margin-bottom: 8px; }
    .log-info { color: #00d4ff; }
    .log-success { color: #00ff88; }
    .log-error { color: #ff4757; }
    .log-warn { color: #ffa502; }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: bold;
    }
    .status-unknown { background: #666; }
    .status-supported { background: #00ff88; color: #000; }
    .status-unsupported { background: #ff4757; }
    .status-subscribed { background: #00d4ff; color: #000; }
    .status-unsubscribed { background: #ffa502; color: #000; }
    #deviceId {
      font-family: monospace;
      background: #0f0f23;
      padding: 8px 12px;
      border-radius: 4px;
      word-break: break-all;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 600px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <h1>WebPushKit Test</h1>

  <div class="section">
    <h2>Configuration</h2>
    <label for="vapidKey">VAPID Public Key</label>
    <input type="text" id="vapidKey" placeholder="Paste your VAPID public key here">

    <label for="baseUrl">Backend URL</label>
    <input type="text" id="baseUrl" value="http://localhost:8000/pusher">

    <label for="apiKey">API Key (optional)</label>
    <input type="text" id="apiKey" placeholder="Leave empty if using CORS">
  </div>

  <div class="section">
    <h2>Status</h2>
    <div class="grid">
      <div>
        <label>Push Support</label>
        <span id="supportStatus" class="status status-unknown">Checking...</span>
      </div>
      <div>
        <label>Subscription</label>
        <span id="subStatus" class="status status-unknown">Unknown</span>
      </div>
    </div>
    <div style="margin-top: 15px;">
      <label>Device ID</label>
      <div id="deviceId">-</div>
    </div>
  </div>

  <div class="section">
    <h2>Actions</h2>
    <button id="btnInit" class="btn-primary">Initialize</button>
    <button id="btnSubscribe" class="btn-success" disabled>Subscribe</button>
    <button id="btnUnsubscribe" class="btn-danger" disabled>Unsubscribe</button>
    <button id="btnCheckStatus" class="btn-secondary">Check Status</button>
  </div>

  <div class="section">
    <h2>Send Test Notification</h2>
    <div class="grid">
      <div>
        <label for="notifyTitle">Title</label>
        <input type="text" id="notifyTitle" value="Test Notification">
      </div>
      <div>
        <label for="notifyBody">Body</label>
        <input type="text" id="notifyBody" value="Hello from WebPushKit!">
      </div>
    </div>
    <button id="btnNotify" class="btn-primary" disabled>Send Notification</button>
  </div>

  <div class="section">
    <h2>Log</h2>
    <div id="log"></div>
    <button id="btnClearLog" class="btn-secondary" style="margin-top: 10px;">Clear Log</button>
  </div>

  <script type="module">
    import { PushNotificationManager } from '/dist/webpushkit.js';

    let pushManager = null;
    const logEl = document.getElementById('log');

    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      const time = new Date().toLocaleTimeString();
      entry.innerHTML = `<span style="color:#666">[${time}]</span> ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateSupportStatus() {
      const el = document.getElementById('supportStatus');
      const supported = 'serviceWorker' in navigator && 'PushManager' in window;
      el.textContent = supported ? 'Supported' : 'Not Supported';
      el.className = `status ${supported ? 'status-supported' : 'status-unsupported'}`;
      return supported;
    }

    async function updateSubscriptionStatus() {
      const el = document.getElementById('subStatus');
      if (!pushManager) {
        el.textContent = 'Not initialized';
        el.className = 'status status-unknown';
        return false;
      }
      try {
        const subscribed = await pushManager.isSubscribed();
        el.textContent = subscribed ? 'Subscribed' : 'Not Subscribed';
        el.className = `status ${subscribed ? 'status-subscribed' : 'status-unsubscribed'}`;
        document.getElementById('btnSubscribe').disabled = subscribed;
        document.getElementById('btnUnsubscribe').disabled = !subscribed;
        document.getElementById('btnNotify').disabled = !subscribed;
        return subscribed;
      } catch (e) {
        el.textContent = 'Error';
        el.className = 'status status-unknown';
        return false;
      }
    }

    function updateDeviceId() {
      if (pushManager) {
        document.getElementById('deviceId').textContent = pushManager.getOrCreateDeviceId();
      }
    }

    function getConfig() {
      const vapidKey = document.getElementById('vapidKey').value.trim();
      const baseURL = document.getElementById('baseUrl').value.trim();
      const apiKey = document.getElementById('apiKey').value.trim();

      if (!vapidKey) {
        throw new Error('VAPID Public Key is required');
      }
      if (!baseURL) {
        throw new Error('Backend URL is required');
      }

      const config = { vapidPublicKey: vapidKey, baseURL };
      if (apiKey) config.apiKey = apiKey;
      return config;
    }

    // Initialize
    document.getElementById('btnInit').addEventListener('click', async () => {
      try {
        const config = getConfig();
        log(`Initializing with baseURL: ${config.baseURL}`);

        pushManager = new PushNotificationManager(config);
        updateDeviceId();

        const result = await pushManager.initialize();
        if (result) {
          log('Initialized successfully!', 'success');
          await updateSubscriptionStatus();
        } else {
          log('Initialization failed - permission denied or not supported', 'error');
        }
      } catch (e) {
        log(`Error: ${e.message}`, 'error');
      }
    });

    // Subscribe
    document.getElementById('btnSubscribe').addEventListener('click', async () => {
      try {
        log('Subscribing...');
        const result = await pushManager.subscribe();
        log(`Subscribed! Device ID: ${result.data.device_id}`, 'success');
        log(`Endpoint: ${result.data.endpoint.substring(0, 50)}...`, 'info');
        await updateSubscriptionStatus();
      } catch (e) {
        log(`Subscribe error: ${e.message}`, 'error');
      }
    });

    // Unsubscribe
    document.getElementById('btnUnsubscribe').addEventListener('click', async () => {
      try {
        log('Unsubscribing...');
        const result = await pushManager.unsubscribe();
        log(`Unsubscribed! Removed: ${result.data.removed_count}`, 'success');
        await updateSubscriptionStatus();
      } catch (e) {
        log(`Unsubscribe error: ${e.message}`, 'error');
      }
    });

    // Check Status
    document.getElementById('btnCheckStatus').addEventListener('click', async () => {
      log('Checking subscription status...');
      const subscribed = await updateSubscriptionStatus();
      log(`Status: ${subscribed ? 'Subscribed' : 'Not subscribed'}`, subscribed ? 'success' : 'warn');
    });

    // Send Notification
    document.getElementById('btnNotify').addEventListener('click', async () => {
      try {
        const title = document.getElementById('notifyTitle').value;
        const body = document.getElementById('notifyBody').value;
        const deviceId = pushManager.getOrCreateDeviceId();

        log(`Sending notification to device: ${deviceId}`);
        const result = await pushManager.notify([deviceId], {
          title,
          body,
          icon: '/icon.png',
          data: { url: '/' }
        });

        const { summary } = result.data;
        if (summary.successful === summary.total) {
          log(`Notification sent successfully!`, 'success');
        } else {
          log(`Partial success: ${summary.successful}/${summary.total}`, 'warn');
          result.data.results.forEach(r => {
            if (!r.success) {
              log(`  Failed for ${r.device_id}: ${r.error}`, 'error');
            }
          });
        }
      } catch (e) {
        log(`Notify error: ${e.message}`, 'error');
      }
    });

    // Clear Log
    document.getElementById('btnClearLog').addEventListener('click', () => {
      logEl.innerHTML = '';
      log('Log cleared');
    });

    // Initial status check
    updateSupportStatus();
    log('Ready. Enter your VAPID key and click Initialize.');
  </script>
</body>
</html>
